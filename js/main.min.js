"use strict";

window.addEventListener("load", function () {
    function animateCSS(element, animationName, callback) {
        function handleAnimationEnd() {
            element.classList.remove(animationName);
            element.removeEventListener("animationend", handleAnimationEnd);
            if (typeof callback === "function") callback();
        }

        element.classList.add("animated", animationName);
        element.addEventListener("animationend", handleAnimationEnd);
    }

    function animateLoad(element, animation, callback) {
        var scrollTop = window.pageYOffset || (document.documentElement || document.body.parentNode || document.body).scrollTop;
        if (scrollTop - viewOffset >= element.offsetTop - window.innerHeight && element.className.indexOf("animated") === -1) {
            animateCSS(element, animation, callback);
        }
    }

    function imageExists(imageUrl) {
        var http = new XMLHttpRequest();
        http.open("HEAD", imageUrl, false);
        http.send();
        return http.status !== 404;
    }

    function slideModalNext(carouselInstance) {
        carouselInstance.next();
        carouselItem = carouselItem.nextElementSibling && carouselItem.nextElementSibling.className.indexOf("controlers") === -1
            ? carouselItem.nextElementSibling
            : document.querySelector("#portofolio .carousel-item");
        setImgSrc(galleryModal[0].el, carouselItem);
    }

    function slideModalPrev(carouselInstance) {
        carouselInstance.prev();
        var lastItem = document.querySelectorAll("#portofolio .carousel-item");
        lastItem = lastItem[lastItem.length - 1];
        carouselItem = carouselItem.previousElementSibling || lastItem;
        setImgSrc(galleryModal[0].el, carouselItem);
    }

    function setCardsHeight() {
        var plansFlip = document.querySelectorAll("#plans .flip_card"),
            plansCardHeight = plansFlip[0].querySelector(".flip_card_front img").height,
            servicesFlip = document.querySelectorAll("#services .flip_card"),
            servicesCardHeight = servicesFlip[0].querySelector(".flip_card_front img").height;

        plansFlip.forEach(function (element) {
            element.style.minHeight = plansCardHeight + "px";
        });
        servicesFlip.forEach(function (element) {
            element.style.minHeight = servicesCardHeight + "px";
        });
    }

    function animateValue(element, start, end, duration) {
        var range = end - start,
            current = start,
            increment = end > start ? 1 : -1,
            stepTime = Math.abs(Math.floor(duration / range)),
            timer = setInterval(function () {
                current += increment;
                element.innerHTML = current;
                if (current === end) {
                    clearInterval(timer);
                }
            }, stepTime);
    }

    function startCount(windowOffset) {
        var target = document.getElementById("advantages");
        if (windowOffset > target.offsetTop && target.className.indexOf("counting") === -1) {
            target.classList.add("counting");
            var happyItem = document.getElementById("happy_item"),
                feedbackItem = document.getElementById("feedback_item"),
                yearsItem = document.getElementById("years_item");
            animateValue(happyItem, 0, happyItem.getAttribute("data-count"), 3000);
            animateValue(feedbackItem, 0, feedbackItem.getAttribute("data-count"), 2500);
            animateValue(yearsItem, 0, yearsItem.getAttribute("data-count"), 2000);
        }
    }

    function getTouches(evt) {
        return evt.touches || evt.originalEvent.touches;
    }

    function handleTouchStart(evt) {
        const firstTouch = getTouches(evt)[0];
        xDown = firstTouch.clientX;
        yDown = firstTouch.clientY;
    }

    function handleTouchMove(evt) {
        if (!xDown || !yDown) {
            return;
        }

        var xUp = evt.touches[0].clientX;
        var yUp = evt.touches[0].clientY;

        var xDiff = xDown - xUp;
        var yDiff = yDown - yUp;

        if (Math.abs(xDiff) > Math.abs(yDiff)) {
            if (xDiff > 0) {
                slideModalNext(carouselInstance);
            } else {
                slideModalPrev(carouselInstance);
            }
        }
        xDown = null;
        yDown = null;
    }

    var body = document.querySelector("body");
    if (/Edge/.test(navigator.userAgent)) body.classList.add("isEdge");

    var navbar = document.querySelector(".nav_container nav"),
        fixed = false,
        toogleNav = function (topScroll) {
            if (!fixed && topScroll > 0) {
                fixed = true;
                navbar.classList.add("active");
            } else if (fixed && topScroll === 0) {
                fixed = false;
                navbar.classList.remove("active");
            }
        };

    var scrollTop = window.pageYOffset || (document.documentElement || document.body.parentNode || document.body).scrollTop;
    toogleNav(scrollTop);

    var viewOffset = window.innerWidth > 425 ? 240 : 0,
        animateOnload = document.querySelectorAll(".should_animate");

    animateOnload.forEach(function (element) {
        if (scrollTop >= element.offsetTop - window.innerHeight) {
            animateLoad(element, element.getAttribute("animate-style"));
        }
    });

    window.onscroll = function () {
        var scrollTop = window.pageYOffset || (document.documentElement || document.body.parentNode || document.body).scrollTop;
        toogleNav(scrollTop);
        animateOnload.forEach(function (element) {
            animateLoad(element, "fadeIn");
        });
        startCount(scrollTop + viewOffset + 200);
    };

    var setImgSrc = function (modal, trigger) {
        var imgSrc = trigger.querySelector("img").getAttribute("src"),
            modalSrc = imgSrc.replace("assets/slider/", "assets/slider/modal/");
        modal.querySelector("img").setAttribute("src", imgSrc);
        if (imageExists(modalSrc)) {
            modal.querySelector("img").setAttribute("src", modalSrc);
        }
    };

    var removeImgSrc = function (modal) {
        modal.querySelector("img").setAttribute("src", "");
    };

    var keySlide = function (event) {
        var carousel = M.Carousel.getInstance(document.querySelector("#portofolio_slider.carousel"));
        if (event.which === 39) {
            slideModalNext(carousel);
        } else if (event.which === 37) {
            slideModalPrev(carousel);
        }
    };

    var parallaxElems = document.querySelectorAll(".parallax"),
        sliderElems = document.querySelectorAll(".carousel"),
        modalElems = document.querySelectorAll(".modal"),
        carouselItem = null,
        modalOptions = {
            onOpenStart: function (modal, trigger) {
                carouselItem = trigger;
                setImgSrc(modal, carouselItem);
                trigger.classList.add("modal_opened");
                window.addEventListener("keydown", function () {
                    keySlide(event);
                });
            },
            startingTop: "1%",
            endingTop: "2.5%",
            onCloseEnd: function (modal) {
                var triggers = document.querySelectorAll("#portofolio_slider .carousel-item");
                removeImgSrc(modal, carouselItem);
                triggers.forEach(function (element) {
                    element.classList.remove("modal_opened");
                });
            }
        };

    M.Parallax.init(parallaxElems, { responsiveThreshold: 425 });
    M.Carousel.init(sliderElems, { fullWidth: true, indicators: false, numVisible: 8 });

    var galleryModal = M.Modal.init(modalElems, modalOptions),
        closeBtn = document.querySelector("#modal.modal i");

    closeBtn.onclick = function () {
        galleryModal[0].close();
    };

    var carouselInstance = M.Carousel.getInstance(sliderElems[0]),
        feedbackInstance = M.Carousel.getInstance(sliderElems[1]);

    var carouselNext = document.getElementById("carousel_right"),
        carouselPrev = document.getElementById("carousel_left"),
        modalNext = document.getElementById("modal_right"),
        modalPrev = document.getElementById("modal_left"),
        feedbackNext = document.getElementById("feedback_right"),
        feedbackPrev = document.getElementById("feedback_left");

    if (carouselNext) {
        carouselNext.onclick = function () {
            carouselInstance.next();
        };
    }

    if (carouselPrev) {
        carouselPrev.onclick = function () {
            carouselInstance.prev();
        };
    }

    if (modalNext) {
        modalNext.onclick = function () {
            slideModalNext(carouselInstance);
        };
    }

    if (modalPrev) {
        modalPrev.onclick = function () {
            slideModalPrev(carouselInstance);
        };
    }

    if (feedbackNext) {
        feedbackNext.onclick = function () {
            feedbackInstance.next();
        };
    }

    if (feedbackPrev) {
        feedbackPrev.onclick = function () {
            feedbackInstance.prev();
        };
    }

    var closestAttr = function (el_class, ev) {
        var target_el = ev.target,
            found = false;
        while (!found && target_el !== null) {
            if (target_el.getAttribute(el_class) !== null) {
                found = true;
            } else {
                target_el = target_el.parentElement;
            }
        }
        return target_el;
    };

    var slideToLocation = function (ev, position) {
        var trigger_el = closestAttr("data-slide", ev),
            location = trigger_el.getAttribute("data-slide");
        location = location.trim();
        document.querySelectorAll("[data-slide]").forEach(function (element) {
            element.classList.remove("active");
        });
        trigger_el.classList.add("active");
        document.getElementById(location).scrollIntoView({
            behavior: "smooth",
            block: position
        });
    };

    var link_triggers = document.querySelectorAll("[data-slide]");
    for (var i = 0; i < link_triggers.length; i++) {
        link_triggers[i].addEventListener("click", function (event) {
            slideToLocation(event, this.getAttribute("data-position"));
        });
    }

    var contactForm = document.getElementById("contactForm");
    if (contactForm) {
        contactForm.addEventListener("submit", function (e) {
            e.preventDefault();
            var formData = new FormData(this);
            if (formData.get("tel") !== "" || formData.get("email") !== "") {
                fetch("modules/contact.php", {
                    method: "POST",
                    body: formData
                });
                M.toast({ html: "Mulțumim că ne-ați contactat" });
                contactForm.reset();
            } else {
                M.toast({ html: "Vă rugăm introduceți numărul de telefon sau adresa de email" });
                return false;
            }
        });
    }

    var applyForm = document.getElementById("applyForm");
    if (applyForm) {
        applyForm.addEventListener("submit", function (e) {
            e.preventDefault();
            var formData = new FormData(this);
            fetch("modules/apply.php", {
                method: "POST",
                body: formData
            });
            M.toast({ html: "Mulțumim pentru aplicare" });
            applyForm.reset();
        });
    }

    setCardsHeight();

    var countDown = document.getElementById("count_down"),
        countDownDate = countDown ? new Date(countDown.getAttribute("data-end")).getTime() : null,
        countDownInterval = countDownDate ? setInterval(function () {
            var now = new Date().getTime(),
                distance = countDownDate - now,
                days = Math.floor(distance / 86400000),
                hours = Math.floor((distance % 86400000) / 3600000),
                minutes = Math.floor((distance % 3600000) / 60000),
                seconds = Math.floor((distance % 60000) / 1000);
            if (countDown) {
                countDown.innerHTML =
                    "<span>" + Math.floor(days / 10) + "</span>\n                <span>" + (days % 10) + "</span><b>:</b>\n                <span>" + Math.floor(hours / 10) + "</span>\n                <span>" + (hours % 10) + "</span><b>:</b>\n                <span>" + Math.floor(minutes / 10) + "</span>\n                <span>" + (minutes % 10) + "</span><b>:</b>\n                <span>" + Math.floor(seconds / 10) + "</span>\n                <span>" + (seconds % 10) + "</span>";
                if (distance < 0) {
                    clearInterval(countDownInterval);
                    countDown.classList.add("expired");
                }
            }
        }, 1000) : null;

    window.onresize = function () {
        setCardsHeight();
    };

    var flipCard = document.querySelectorAll(".flip_card_inner");
    flipCard.forEach(function (element) {
        element.onclick = function () {
            var parent = element.parentElement;
            while (parent && parent.className.indexOf("guided") === -1) {
                parent = parent.parentElement;
            }
            if (parent) parent.classList.remove("guided");
        };
    });

    var flippingCards = document.querySelectorAll(".flip_card");
    if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
        flippingCards.forEach(function (element) {
            element.classList.add("active");
            element.onclick = function () {
                if (element.className.indexOf("active") === -1) {
                    element.classList.add("active");
                } else {
                    element.classList.remove("active");
                }
            };
        });
    }

    modalElems[0].addEventListener("touchstart", function (evt) {
        const firstTouch = getTouches(evt)[0];
        xDown = firstTouch.clientX;
        yDown = firstTouch.clientY;
    }, false);

    modalElems[0].addEventListener("touchmove", handleTouchMove, false);

    var xDown = null,
        yDown = null;

    var carouselImages = document.querySelectorAll("#portofolio .carousel-item img");
    setTimeout(function () {
        carouselImages.forEach(function (element) {
            var imgSrc = element.getAttribute("src"),
                modalSrc = imgSrc.replace("assets/slider/", "assets/slider/modal/");
            console.log(imageExists(modalSrc));
        });
    }, 10000);
});
